# ============================================================================
# RENDER BLUEPRINT - Binance Bot com PostgreSQL
# ============================================================================
# Documentação: https://render.com/docs/blueprint-spec

services:
  # --------------------------------------------------------------------------
  # WORKER SERVICE - Bot Autônomo (executa 24/7)
  # --------------------------------------------------------------------------
  - type: worker
    name: binance-bot-worker
    runtime: python
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/init_render_env.py && python bot_master.py

    # Variáveis de ambiente não-sensíveis (sensíveis via Dashboard Render)
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SCAN_INTERVAL
        value: 60
      - key: MONITOR_INTERVAL
        value: 15
      - key: MAX_POSITIONS
        value: 3
      - key: MIN_SIGNAL_STRENGTH
        value: 28
      - key: ALAVANCAGEM_PADRAO
        value: 50
      - key: RISCO_MAXIMO_POR_OPERACAO
        value: 0.12
      - key: STOP_LOSS_PERCENTUAL
        value: 0.015
      - key: TAKE_PROFIT_PERCENTUAL
        value: 0.025

    # Health check para detectar se o bot está rodando
    healthCheckPath: /health

    # Auto-deploy do branch main
    branch: main

  # --------------------------------------------------------------------------
  # WEB SERVICE - Dashboard Streamlit
  # --------------------------------------------------------------------------
  - type: web
    name: binance-dashboard
    runtime: python
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: streamlit run dashboard.py --server.port=$PORT --server.address=0.0.0.0 --server.headless=true

    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: PORT
        value: 8501
      - key: STREAMLIT_SERVER_HEADLESS
        value: true
      - key: STREAMLIT_SERVER_ADDRESS
        value: 0.0.0.0

    # Dashboard acessível publicamente
    branch: main

# --------------------------------------------------------------------------
# DATABASE - PostgreSQL para persistência
# --------------------------------------------------------------------------
databases:
  - name: binance-bot-db
    databaseName: binance_bot
    user: binance_bot_user
    plan: free
    # IP limit para segurança (opcional - remover para acesso de qualquer lugar)
    # ipAllowList: []

# ============================================================================
# NOTAS DE IMPLEMENTAÇÃO
# ============================================================================
#
# 1. ANTES DO DEPLOY:
#    - Execute database/schema.sql no banco PostgreSQL criado
#    - Configure variáveis sensíveis no Dashboard Render:
#      * BINANCE_API_KEY
#      * BINANCE_API_SECRET
#      * OPENAI_API_KEY (opcional)
#      * TELEGRAM_BOT_TOKEN (opcional)
#      * TELEGRAM_CHAT_ID (opcional)
#
# 2. CONEXÃO COM BANCO:
#    - O Render injeta automaticamente DATABASE_URL nas env vars
#    - Formato: postgres://user:pass@host:port/db
#    - O bot detecta e usa automaticamente via database/db_integration.py
#
# 3. HEALTH CHECK:
#    - Implemente um endpoint /health simples no bot se necessário
#    - Ou remova healthCheckPath se não usar
#
# 4. RODAR SCHEMA SQL:
#    Opção A - Via psql no Render:
#    render.com -> PostgreSQL Service -> Connect -> External Connection
#    psql < database/schema.sql
#
#    Opção B - Via script Python (automático no primeiro deploy):
#    O código database/db_integration.py tenta criar tabelas se não existirem
#
# 5. LOGS:
#    - Acompanhe em render.com -> seu serviço -> Logs
#    - Procure por "PostgreSQL" para confirmar conexão
# ============================================================================
